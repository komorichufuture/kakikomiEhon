<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãƒ­ãƒ¼ã‚«ãƒ«çµµæœ¬ã‚¨ãƒ‡ã‚£ã‚¿</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Yu Mincho", "Hiragino Mincho ProN", serif;
      background: #f5f5f5;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    header {
      background: #222;
      color: #fff;
      padding: 8px 12px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    header button {
      padding: 4px 10px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
    }

    header button:hover {
      opacity: 0.8;
    }

    #layoutSelect {
      padding: 2px 6px;
      font-size: 13px;
    }

    #pageIndicator {
      margin-left: auto;
      font-size: 13px;
      opacity: 0.8;
    }

    main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    /* ä¸Šä¸‹2åˆ†å‰²ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .pane {
      flex: 1;
      position: relative;
      display: flex;
    }

    #topPane {
      background: #000;
      color: #fff;
    }

    #bottomPane {
      background: #fff;
      border-top: 3px solid #000;
    }

    .image-container,
    .text-container {
      flex: 1;
      width: 100%;
      height: 100%;
      display: flex;
      position: relative;
    }

    .image-inner {
      border-radius: 8px;
      padding: 10px;
      text-align: center;
      max-width: 90%;
      max-height: 90%;
      margin: auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    #topImageDropArea,
    #bottomImageDropArea {
      border: 2px dashed #666;
      background: rgba(0,0,0,0.3);
      color: #fff;
    }

    #bottomImageDropArea {
      background: rgba(255,255,255,0.6);
      color: #000;
    }

    #topPane.dragover,
    #bottomPane.dragover {
      outline: 3px dashed #fff;
    }

    #bottomPane.dragover {
      outline-color: #000;
    }

    .image-inner.dragover {
      border-color: #fff;
      background: rgba(255,255,255,0.1);
    }

    .image-inner button {
      padding: 4px 10px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
    }

    .image-preview {
      max-width: 100%;
      max-height: 70vh;
      object-fit: contain;
      display: none;
      cursor: pointer; /* ã‚¯ãƒªãƒƒã‚¯ã§å·®ã—æ›¿ãˆ */
    }

    #topTextArea,
    #bottomTextArea {
      flex: 1;
      width: 100%;
      border: none;
      resize: none;
      font-size: 20px;
      line-height: 1.6;
      outline: none;
      background: transparent;
      padding: 16px;
    }

    #topTextArea {
      color: #fff;
    }

    #bottomTextArea {
      color: #000;
    }

    #topTextArea::placeholder,
    #bottomTextArea::placeholder {
      color: #bbb;
    }

    #fileInput,
    #topImageFileInput,
    #bottomImageFileInput {
      display: none;
    }

    footer {
      font-size: 11px;
      text-align: right;
      padding: 4px 8px;
      color: #666;
    }

    @media (max-width: 800px) {
      #topTextArea,
      #bottomTextArea { font-size: 16px; }
    }

    /* ===== ãƒšãƒ¼ã‚¸ä¸€è¦§ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ ===== */
    #pageListOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    #pageListOverlay.active {
      display: flex;
    }

    #pageListPanel {
      background: #fff;
      max-width: 900px;
      max-height: 80vh;
      width: 95%;
      border-radius: 10px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.4);
      display: flex;
      flex-direction: column;
    }

    #pageListHeader {
      padding: 8px 12px;
      border-bottom: 1px solid #ddd;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 14px;
    }

    #pageListBody {
      padding: 8px 12px 12px;
      overflow-y: auto;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 8px;
    }

    .page-card {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 6px;
      font-size: 12px;
      display: flex;
      flex-direction: column;
      background: #fafafa;
      cursor: pointer;
    }

    .page-card.current {
      border-color: #007bff;
      box-shadow: 0 0 0 2px rgba(0,123,255,0.3);
    }

    .page-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      font-weight: bold;
    }

    .page-card-layout {
      font-size: 11px;
      opacity: 0.7;
    }

    .page-card-thumbs {
      display: flex;
      flex-direction: column;
      gap: 2px;
      margin-bottom: 4px;
    }

    .page-card-thumbs img {
      width: 100%;
      max-height: 60px;
      object-fit: cover;
      border-radius: 3px;
      border: 1px solid #ddd;
      background: #eee;
    }

    .page-card-preview {
      flex: 1;
      font-size: 11px;
      color: #555;
      white-space: pre-wrap;
      overflow: hidden;
      max-height: 4.5em;
      margin-top: 2px;
    }

    .page-card-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 4px;
      margin-top: 4px;
    }

    .page-card button {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      background: #eee;
    }

    .page-card button:hover {
      background: #ddd;
    }

    #closePageListBtn {
      padding: 2px 8px;
      font-size: 12px;
    }
  </style>
</head>
<body>
<header>
  <button id="prevPageBtn">â† å‰ã®ãƒšãƒ¼ã‚¸</button>
  <button id="nextPageBtn">æ¬¡ã®ãƒšãƒ¼ã‚¸ â†’</button>
  <button id="addPageBtn">ï¼‹ ãƒšãƒ¼ã‚¸è¿½åŠ </button>
  <button id="deletePageBtn">âœ• ãƒšãƒ¼ã‚¸å‰Šé™¤</button>

  <select id="layoutSelect">
    <option value="image_text">ä¸Šï¼šç”»åƒ / ä¸‹ï¼šæ–‡å­—</option>
    <option value="image_image">ä¸Šï¼šç”»åƒ / ä¸‹ï¼šç”»åƒ</option>
    <option value="text_text">ä¸Šï¼šæ–‡å­— / ä¸‹ï¼šæ–‡å­—</option>
  </select>

  <button id="pageListBtn">ğŸ“š ãƒšãƒ¼ã‚¸ä¸€è¦§</button>

  <button id="saveFileBtn">ğŸ’¾ æ›¸ãå‡ºã—</button>
  <label>
    <button id="loadFileBtn">ğŸ“‚ èª­ã¿è¾¼ã¿</button>
    <input id="fileInput" type="file" accept="application/json">
  </label>

  <span id="pageIndicator"></span>
</header>

<main>
  <!-- ä¸Šï¼šç”»åƒ or ãƒ†ã‚­ã‚¹ãƒˆ -->
  <section id="topPane" class="pane">
    <!-- ç”»åƒãƒ¢ãƒ¼ãƒ‰ -->
    <div id="topImageContainer" class="image-container">
      <div id="topImageDropArea" class="image-inner">
        <p>ã“ã“ã«ç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—<br>ã¾ãŸã¯ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰é¸æŠ</p>
        <button id="topSelectImageBtn">ç”»åƒã‚’é¸æŠ</button>
        <button id="topClearImageBtn">ç”»åƒã‚’å‰Šé™¤</button>
        <input id="topImageFileInput" type="file" accept="image/*">
      </div>
      <img id="topImagePreview" class="image-preview" alt="ä¸Šæ®µç”»åƒ">
    </div>

    <!-- ãƒ†ã‚­ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ -->
    <div id="topTextContainer" class="text-container">
      <textarea id="topTextArea"
        placeholder="ã“ã“ã«ä¸Šæ®µã®æ–‡ç« ã‚’æ›¸ãã¾ã™ã€‚&#10;ä¸¡æ–¹æ–‡å­—ã®ãƒšãƒ¼ã‚¸ã«ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚"></textarea>
    </div>
  </section>

  <!-- ä¸‹ï¼šç”»åƒ or ãƒ†ã‚­ã‚¹ãƒˆ -->
  <section id="bottomPane" class="pane">
    <!-- ç”»åƒãƒ¢ãƒ¼ãƒ‰ -->
    <div id="bottomImageContainer" class="image-container">
      <div id="bottomImageDropArea" class="image-inner">
        <p>ã“ã“ã«ç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—<br>ã¾ãŸã¯ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰é¸æŠ</p>
        <button id="bottomSelectImageBtn">ç”»åƒã‚’é¸æŠ</button>
        <button id="bottomClearImageBtn">ç”»åƒã‚’å‰Šé™¤</button>
        <input id="bottomImageFileInput" type="file" accept="image/*">
      </div>
      <img id="bottomImagePreview" class="image-preview" alt="ä¸‹æ®µç”»åƒ">
    </div>

    <!-- ãƒ†ã‚­ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ -->
    <div id="bottomTextContainer" class="text-container">
      <textarea id="bottomTextArea"
        placeholder="ã“ã“ã«ä¸‹æ®µã®æ–‡ç« ã‚’æ›¸ãã¾ã™ã€‚&#10;ã‚³ãƒ”ãƒ¼ãƒ»ãƒšãƒ¼ã‚¹ãƒˆã‚„é¸æŠã‚³ãƒ”ãƒ¼ã‚‚ã§ãã¾ã™ã€‚"></textarea>
    </div>
  </section>
</main>

<footer>
  ãƒ‡ãƒ¼ã‚¿ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆï¼‹å¿…è¦ãªã‚‰JSONã§æ›¸ãå‡ºã—ï¼‰ã€‚
</footer>

<!-- ãƒšãƒ¼ã‚¸ä¸€è¦§ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
<div id="pageListOverlay">
  <div id="pageListPanel">
    <div id="pageListHeader">
      <span>ãƒšãƒ¼ã‚¸ä¸€è¦§</span>
      <button id="closePageListBtn">é–‰ã˜ã‚‹</button>
    </div>
    <div id="pageListBody">
      <!-- JSã§ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ -->
    </div>
  </div>
</div>

<script>
// =======================
// ã‚¿ã‚¤ãƒ—ãƒ©ã‚¤ã‚¿ãƒ¼ã‚¢ãƒ‹ãƒ¡
// =======================

// å„ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã”ã¨ã«ã‚¢ãƒ‹ãƒ¡çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹
const typingState = new WeakMap();
// å¿…è¦ãªã‚‰ã“ã“ã‚’ false ã«ã™ã‚Œã°ã‚¢ãƒ‹ãƒ¡ç„¡åŠ¹
let enableTypeAnimation = true;

function typeText(target, text, speed = 25) {
  // ã‚¢ãƒ‹ãƒ¡ OFF â†’ å³è¡¨ç¤º
  if (!enableTypeAnimation) {
    target.value = text;
    return;
  }

  // ã“ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå°‚ç”¨ã®çŠ¶æ…‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
  const state = { cancelled: false };
  typingState.set(target, state);

  let i = 0;
  target.value = "";

  function step() {
    const current = typingState.get(target);

    // ä»–ã®ã‚¢ãƒ‹ãƒ¡ã«ä¸Šæ›¸ãã•ã‚ŒãŸ / ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸ
    if (!current || current !== state || current.cancelled) {
      target.value = text;
      return;
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç·¨é›†ã‚’å§‹ã‚ãŸã‚‰å³çµ‚äº†
    if (document.activeElement === target) {
      current.cancelled = true;
      target.value = text;
      return;
    }

    target.value = text.slice(0, i);
    i++;

    if (i <= text.length) {
      target.scrollTop = target.scrollHeight;
      setTimeout(step, speed);
    } else {
      current.cancelled = true;
    }
  }

  // å°‘ã—å¾…ã£ã¦ã‹ã‚‰é–‹å§‹ï¼ˆé€£ç¶šãƒšãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆã®ãƒãƒ©ã¤ãé˜²æ­¢ï¼‰
  setTimeout(step, 20);
}

// =======================
// ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
// =======================
let pages = [];
let currentPageIndex = 0;
const STORAGE_KEY = "localPictureBook_v2";

function createEmptyPage() {
  return {
    layout: "image_text",   // "image_text" | "image_image" | "text_text"
    topImageData: null,
    bottomImageData: null,
    topText: "",
    bottomText: ""
  };
}

// =======================
// DOMå–å¾—
// =======================
const layoutSelect = document.getElementById("layoutSelect");

const topPane = document.getElementById("topPane");
const bottomPane = document.getElementById("bottomPane");

const topImageContainer = document.getElementById("topImageContainer");
const topImageDropArea = document.getElementById("topImageDropArea");
const topImagePreview = document.getElementById("topImagePreview");
const topImageFileInput = document.getElementById("topImageFileInput");
const topSelectImageBtn = document.getElementById("topSelectImageBtn");
const topClearImageBtn = document.getElementById("topClearImageBtn");

const bottomImageContainer = document.getElementById("bottomImageContainer");
const bottomImageDropArea = document.getElementById("bottomImageDropArea");
const bottomImagePreview = document.getElementById("bottomImagePreview");
const bottomImageFileInput = document.getElementById("bottomImageFileInput");
const bottomSelectImageBtn = document.getElementById("bottomSelectImageBtn");
const bottomClearImageBtn = document.getElementById("bottomClearImageBtn");

const topTextContainer = document.getElementById("topTextContainer");
const bottomTextContainer = document.getElementById("bottomTextContainer");
const topTextArea = document.getElementById("topTextArea");
const bottomTextArea = document.getElementById("bottomTextArea");

const prevPageBtn = document.getElementById("prevPageBtn");
const nextPageBtn = document.getElementById("nextPageBtn");
const addPageBtn = document.getElementById("addPageBtn");
const deletePageBtn = document.getElementById("deletePageBtn");
const pageIndicator = document.getElementById("pageIndicator");

const saveFileBtn = document.getElementById("saveFileBtn");
const loadFileBtn = document.getElementById("loadFileBtn");
const fileInput = document.getElementById("fileInput");

const pageListBtn = document.getElementById("pageListBtn");
const pageListOverlay = document.getElementById("pageListOverlay");
const pageListBody = document.getElementById("pageListBody");
const closePageListBtn = document.getElementById("closePageListBtn");

// ã€ŒğŸ“‚ èª­ã¿è¾¼ã¿ã€ãƒœã‚¿ãƒ³ â†’ ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
loadFileBtn.addEventListener("click", () => {
  fileInput.click();
});

// =======================
// ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ˜ãƒ«ãƒ‘
// =======================
function topHasImageLayout(layout) {
  return layout === "image_text" || layout === "image_image";
}
function bottomHasImageLayout(layout) {
  return layout === "image_image";
}

// =======================
// æ—§å½¢å¼ã‹ã‚‰ã®å¤‰æ›
// =======================
function normalizePage(p) {
  // æ–°å½¢å¼ãªã‚‰ãã®ã¾ã¾ï¼ˆè£œå®Œï¼‰
  if ("layout" in p || "topImageData" in p || "bottomImageData" in p ||
      "topText" in p || "bottomText" in p) {
    return {
      layout: p.layout || "image_text",
      topImageData: p.topImageData ?? p.imageData ?? null,
      bottomImageData: p.bottomImageData ?? null,
      topText: p.topText ?? "",
      bottomText: p.bottomText ?? p.text ?? ""
    };
  }
  // æ—§å½¢å¼ (imageData + text) ã‹ã‚‰ã®å¤‰æ›
  if ("imageData" in p || "text" in p) {
    return {
      layout: "image_text",
      topImageData: p.imageData ?? null,
      bottomImageData: null,
      topText: "",
      bottomText: p.text ?? ""
    };
  }
  // ä¸æ˜ãªå ´åˆã¯ç©ºãƒšãƒ¼ã‚¸
  return createEmptyPage();
}

// =======================
// ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
// =======================
function loadFromLocalStorage() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) {
    pages = [createEmptyPage()];
    currentPageIndex = 0;
    return;
  }
  try {
    const data = JSON.parse(raw);
    if (Array.isArray(data.pages)) {
      pages = data.pages.map(normalizePage);
      currentPageIndex = Math.min(
        Math.max(0, data.currentPageIndex || 0),
        pages.length - 1
      );
    } else {
      pages = [createEmptyPage()];
      currentPageIndex = 0;
    }
  } catch (e) {
    console.error("load error:", e);
    pages = [createEmptyPage()];
    currentPageIndex = 0;
  }
}

function saveToLocalStorage() {
  saveCurrentPageState();
  const data = {
    pages,
    currentPageIndex
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

// =======================
// ãƒšãƒ¼ã‚¸æç”»
// =======================
function renderPage() {
  const page = pages[currentPageIndex];
  const layout = page.layout || "image_text";

  layoutSelect.value = layout;

  const topImageMode = topHasImageLayout(layout);
  const bottomImageMode = bottomHasImageLayout(layout);

  // ä¸Šæ®µ
  if (topImageMode) {
    topImageContainer.style.display = "flex";
    topTextContainer.style.display = "none";

    if (page.topImageData) {
      topImagePreview.src = page.topImageData;
      topImagePreview.style.display = "block";
      topImageDropArea.style.display = "none";
    } else {
      topImagePreview.style.display = "none";
      topImageDropArea.style.display = "flex";
    }
  } else {
    topImageContainer.style.display = "none";
    topTextContainer.style.display = "flex";
  }

  // ä¸‹æ®µ
  if (bottomImageMode) {
    bottomImageContainer.style.display = "flex";
    bottomTextContainer.style.display = "none";

    if (page.bottomImageData) {
      bottomImagePreview.src = page.bottomImageData;
      bottomImagePreview.style.display = "block";
      bottomImageDropArea.style.display = "flex";
    } else {
      bottomImagePreview.style.display = "none";
      bottomImageDropArea.style.display = "flex";
    }
  } else {
    bottomImageContainer.style.display = "none";
    bottomTextContainer.style.display = "flex";
  }

  // ãƒ†ã‚­ã‚¹ãƒˆå†…å®¹ï¼ˆã¾ãšã¯ç´ ã§å…¥ã‚Œã¦ãŠãï¼‰
  topTextArea.value = page.topText || "";
  bottomTextArea.value = page.bottomText || "";

  // ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿
  pageIndicator.textContent = `ãƒšãƒ¼ã‚¸ ${currentPageIndex + 1} / ${pages.length}`;

  // ===== ã‚¿ã‚¤ãƒ—ã‚¢ãƒ‹ãƒ¡é©ç”¨ =====
  // layoutã”ã¨ã«ã€Œãƒ†ã‚­ã‚¹ãƒˆãŒè¦‹ãˆã¦ã„ã‚‹å´ã ã‘ã€ã‚¢ãƒ‹ãƒ¡ã•ã›ã‚‹

  // ä¸Šæ®µãƒ†ã‚­ã‚¹ãƒˆãŒè¦‹ãˆã‚‹ã®ã¯ text_text ã®ã¨ãã ã‘
  if (layout === "text_text" && page.topText) {
    typeText(topTextArea, page.topText, 25);
  }

  // ä¸‹æ®µãƒ†ã‚­ã‚¹ãƒˆãŒè¦‹ãˆã‚‹ã®ã¯ text_text ã¨ image_text ã®ã¨ã
  if ((layout === "text_text" || layout === "image_text") && page.bottomText) {
    typeText(bottomTextArea, page.bottomText, 25);
  }
}

// =======================
// ãƒšãƒ¼ã‚¸çŠ¶æ…‹ä¿å­˜
// =======================
function saveCurrentPageState() {
  const page = pages[currentPageIndex];
  page.topText = topTextArea.value;
  page.bottomText = bottomTextArea.value;
  // ç”»åƒã¯ãã‚Œãã‚Œã®ãƒãƒ³ãƒ‰ãƒ©ã§æ›´æ–°æ¸ˆã¿
}

// =======================
// ãƒšãƒ¼ã‚¸æ“ä½œ
// =======================
function goToPage(index) {
  if (index < 0 || index >= pages.length) return;
  saveCurrentPageState();
  currentPageIndex = index;
  renderPage();
  saveToLocalStorage();
}

function addPage() {
  saveCurrentPageState();
  const newPage = createEmptyPage();
  pages.splice(currentPageIndex + 1, 0, newPage);
  currentPageIndex++;
  renderPage();
  saveToLocalStorage();
  renderPageList();
}

function deletePage() {
  if (pages.length === 1) {
    pages[0] = createEmptyPage();
    currentPageIndex = 0;
  } else {
    pages.splice(currentPageIndex, 1);
    if (currentPageIndex >= pages.length) {
      currentPageIndex = pages.length - 1;
    }
  }
  renderPage();
  saveToLocalStorage();
  renderPageList(); // ä¸€è¦§ã‚’é–‹ã„ã¦ãŸã‚‰æ›´æ–°
}

function movePage(oldIndex, newIndex) {
  if (newIndex < 0 || newIndex >= pages.length) return;
  const [p] = pages.splice(oldIndex, 1);
  pages.splice(newIndex, 0, p);
  currentPageIndex = newIndex;
  renderPage();
  saveToLocalStorage();
  renderPageList();
}

// =======================
// ç”»åƒèª­ã¿è¾¼ã¿
// =======================
function handleImageFile(position, file) {
  if (!file || !file.type.startsWith("image/")) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    const dataUrl = e.target.result;
    const page = pages[currentPageIndex];
    if (position === "top") {
      page.topImageData = dataUrl;
    } else {
      page.bottomImageData = dataUrl;
    }
    renderPage();
    saveToLocalStorage();
    renderPageList(); // ã‚µãƒ ãƒæƒ…å ±æ›´æ–°
  };
  reader.readAsDataURL(file);
}

// ãƒ‰ãƒ©ãƒƒã‚° & ãƒ‰ãƒ­ãƒƒãƒ—ï¼ˆä¸Šæ®µï¼‰
topPane.addEventListener("dragover", (e) => {
  e.preventDefault();
  const layout = pages[currentPageIndex].layout;
  if (topHasImageLayout(layout)) {
    topPane.classList.add("dragover");
  }
});

topPane.addEventListener("dragleave", () => {
  topPane.classList.remove("dragover");
});

topPane.addEventListener("drop", (e) => {
  e.preventDefault();
  topPane.classList.remove("dragover");
  const layout = pages[currentPageIndex].layout;
  if (!topHasImageLayout(layout)) return;
  const file = e.dataTransfer.files[0];
  handleImageFile("top", file);
});

// ãƒ‰ãƒ©ãƒƒã‚° & ãƒ‰ãƒ­ãƒƒãƒ—ï¼ˆä¸‹æ®µï¼‰
bottomPane.addEventListener("dragover", (e) => {
  e.preventDefault();
  const layout = pages[currentPageIndex].layout;
  if (bottomHasImageLayout(layout)) {
    bottomPane.classList.add("dragover");
  }
});

bottomPane.addEventListener("dragleave", () => {
  bottomPane.classList.remove("dragover");
});

bottomPane.addEventListener("drop", (e) => {
  e.preventDefault();
  bottomPane.classList.remove("dragover");
  const layout = pages[currentPageIndex].layout;
  if (!bottomHasImageLayout(layout)) return;
  const file = e.dataTransfer.files[0];
  handleImageFile("bottom", file);
});

// ç”»åƒé¸æŠãƒœã‚¿ãƒ³ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³
topSelectImageBtn.addEventListener("click", () => {
  topImageFileInput.click();
});

topImageFileInput.addEventListener("change", (e) => {
  const file = e.target.files[0];
  handleImageFile("top", file);
  topImageFileInput.value = "";
});

topClearImageBtn.addEventListener("click", () => {
  pages[currentPageIndex].topImageData = null;
  renderPage();
  saveToLocalStorage();
  renderPageList();
});

bottomSelectImageBtn.addEventListener("click", () => {
  bottomImageFileInput.click();
});

bottomImageFileInput.addEventListener("change", (e) => {
  const file = e.target.files[0];
  handleImageFile("bottom", file);
  bottomImageFileInput.value = "";
});

bottomClearImageBtn.addEventListener("click", () => {
  pages[currentPageIndex].bottomImageData = null;
  renderPage();
  saveToLocalStorage();
  renderPageList();
});

// ç”»åƒã‚¯ãƒªãƒƒã‚¯ã§å·®ã—æ›¿ãˆ
topImagePreview.addEventListener("click", () => {
  topImageFileInput.click();
});

bottomImagePreview.addEventListener("click", () => {
  bottomImageFileInput.click();
});

// =======================
// ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå¤‰æ›´
// =======================
layoutSelect.addEventListener("change", () => {
  saveCurrentPageState();
  pages[currentPageIndex].layout = layoutSelect.value;
  renderPage();
  saveToLocalStorage();
  renderPageList();
});

// =======================
// ãƒ†ã‚­ã‚¹ãƒˆå¤‰æ›´ â†’ è‡ªå‹•ä¿å­˜
// =======================
let textSaveTimer = null;
function scheduleTextSave() {
  if (textSaveTimer) clearTimeout(textSaveTimer);
  textSaveTimer = setTimeout(() => {
    saveToLocalStorage();
    renderPageList();
  }, 500);
}

topTextArea.addEventListener("input", scheduleTextSave);
bottomTextArea.addEventListener("input", scheduleTextSave);

// =======================
// ãƒšãƒ¼ã‚¸ä¸€è¦§ï¼ˆã‚µãƒ ãƒã‚¤ãƒ«ï¼‰
// =======================
function layoutLabel(layout) {
  switch (layout) {
    case "image_text": return "ä¸Š:ç”»åƒ / ä¸‹:æ–‡å­—";
    case "image_image": return "ä¸Š:ç”»åƒ / ä¸‹:ç”»åƒ";
    case "text_text": return "ä¸Š:æ–‡å­— / ä¸‹:æ–‡å­—";
    default: return layout;
  }
}

function renderPageList() {
  if (!pageListOverlay.classList.contains("active")) return;
  pageListBody.innerHTML = "";

  pages.forEach((p, index) => {
    const card = document.createElement("div");
    card.className = "page-card";
    if (index === currentPageIndex) {
      card.classList.add("current");
    }

    const header = document.createElement("div");
    header.className = "page-card-header";
    const titleSpan = document.createElement("span");
    titleSpan.textContent = `P.${index + 1}`;
    const layoutSpan = document.createElement("span");
    layoutSpan.className = "page-card-layout";
    layoutSpan.textContent = layoutLabel(p.layout || "image_text");
    header.appendChild(titleSpan);
    header.appendChild(layoutSpan);

    // ã‚µãƒ ãƒã‚¤ãƒ«ï¼ˆä¸Šç”»åƒãƒ»ä¸‹ç”»åƒï¼‰
    const thumbs = document.createElement("div");
    thumbs.className = "page-card-thumbs";

    const hasTopImg = !!p.topImageData;
    const hasBottomImg = !!p.bottomImageData;

    if (hasTopImg) {
      const imgTop = document.createElement("img");
      imgTop.src = p.topImageData;
      imgTop.alt = "ä¸Šæ®µç”»åƒã‚µãƒ ãƒã‚¤ãƒ«";
      thumbs.appendChild(imgTop);
    }
    if (hasBottomImg) {
      const imgBottom = document.createElement("img");
      imgBottom.src = p.bottomImageData;
      imgBottom.alt = "ä¸‹æ®µç”»åƒã‚µãƒ ãƒã‚¤ãƒ«";
      thumbs.appendChild(imgBottom);
    }

    // ãƒ†ã‚­ã‚¹ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
    const preview = document.createElement("div");
    preview.className = "page-card-preview";
    let textPreview = "";
    if (p.topText) textPreview += p.topText.split("\n")[0];
    if (p.bottomText) {
      if (textPreview) textPreview += "\n";
      textPreview += p.bottomText.split("\n")[0];
    }
    if (!textPreview && !hasTopImg && !hasBottomImg) {
      textPreview = "ï¼ˆå†…å®¹ãªã—ï¼‰";
    }
    preview.textContent = textPreview;

    const buttons = document.createElement("div");
    buttons.className = "page-card-buttons";
    const upBtn = document.createElement("button");
    upBtn.textContent = "â†‘";
    const downBtn = document.createElement("button");
    downBtn.textContent = "â†“";

    upBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      movePage(index, index - 1);
    });
    downBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      movePage(index, index + 1);
    });

    buttons.appendChild(upBtn);
    buttons.appendChild(downBtn);

    card.appendChild(header);
    if (hasTopImg || hasBottomImg) {
      card.appendChild(thumbs);
    }
    card.appendChild(preview);
    card.appendChild(buttons);

    card.addEventListener("click", () => {
      goToPage(index);
      closePageList();
    });

    pageListBody.appendChild(card);
  });
}

function openPageList() {
  pageListOverlay.classList.add("active");
  renderPageList();
}

function closePageList() {
  pageListOverlay.classList.remove("active");
}

pageListBtn.addEventListener("click", openPageList);
closePageListBtn.addEventListener("click", closePageList);
pageListOverlay.addEventListener("click", (e) => {
  if (e.target === pageListOverlay) {
    closePageList();
  }
});

// =======================
// JSONã¨ã—ã¦æ›¸ãå‡ºã—ï¼èª­ã¿è¾¼ã¿
// =======================
saveFileBtn.addEventListener("click", () => {
  saveCurrentPageState();
  const data = {
    pages,
    currentPageIndex
  };
  const json = JSON.stringify(data, null, 2);
  const blob = new Blob([json], { type: "application/json" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "picture_book.json";
  a.click();
  URL.revokeObjectURL(url);
});

fileInput.addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    try {
      const data = JSON.parse(ev.target.result);
      if (Array.isArray(data.pages)) {
        pages = data.pages.map(normalizePage);
        currentPageIndex = Math.min(
          Math.max(0, data.currentPageIndex || 0),
          pages.length - 1
        );
        renderPage();
        saveToLocalStorage();
        renderPageList();
      } else {
        alert("ãƒ•ã‚¡ã‚¤ãƒ«ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚");
      }
    } catch (err) {
      console.error(err);
      alert("JSONã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    }
  };
  reader.readAsText(file, "utf-8");
  fileInput.value = "";
});

// =======================
// ãƒšãƒ¼ã‚¸é€ã‚Šãƒœã‚¿ãƒ³
// =======================
prevPageBtn.addEventListener("click", () => {
  goToPage(currentPageIndex - 1);
});

nextPageBtn.addEventListener("click", () => {
  goToPage(currentPageIndex + 1);
});

addPageBtn.addEventListener("click", addPage);
deletePageBtn.addEventListener("click", deletePage);

// =======================
// èµ·å‹•æ™‚
// =======================
loadFromLocalStorage();
renderPage();

// é›¢è„±å‰ã«ä¿å­˜
window.addEventListener("beforeunload", saveToLocalStorage);
</script>
</body>
</html>
